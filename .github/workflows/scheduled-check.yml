# Scheduled CI to test key R geospatial packages against multiple GDAL versions
# Runs fortnightly and can be triggered manually

name: Scheduled GDAL Compatibility Check

on:
  schedule:
    # Run at 02:00 UTC on the 1st and 15th of each month (fortnightly-ish)
    - cron: '0 2 1,15 * *'
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to test (comma-separated, or "all")'
        required: false
        default: 'all'
        type: string

env:
  # All packages to test when running scheduled or "all"
  ALL_PACKAGES: 'gdalcubes,gdalraster,sf,terra,vapour'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: Determine packages to test
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.set-matrix.outputs.packages }}
    steps:
      - id: set-matrix
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.packages }}" != "all" ]; then
            PKGS="${{ inputs.packages }}"
          else
            PKGS="${{ env.ALL_PACKAGES }}"
          fi
          # Convert comma-separated list to JSON array
          JSON=$(echo "$PKGS" | tr ',' '\n' | jq -R . | jq -s -c '.')
          echo "packages=$JSON" >> $GITHUB_OUTPUT

  check:
    name: ${{ matrix.package }} / GDAL ${{ matrix.gdal-version }}
    needs: setup
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/osgeo/gdal:${{ matrix.gdal-image }}

    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.setup.outputs.packages) }}
        gdal-version: ['3.9', '3.12', 'latest']
        include:
          - gdal-version: '3.9'
            gdal-image: 'ubuntu-full-3.9.3'
          - gdal-version: '3.12'
            gdal-image: 'ubuntu-full-3.12.1'
          - gdal-version: 'latest'
            gdal-image: 'ubuntu-full-latest'

    steps:
      - name: Install system dependencies
        run: |
          apt-get update -qq
          apt-get install -y --no-install-recommends \
            software-properties-common \
            dirmngr \
            wget \
            ca-certificates \
            gnupg \
            git \
            pkg-config \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff-dev \
            libjpeg-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libsqlite3-dev \
            libudunits2-dev \
            libnetcdf-dev \
            netcdf-bin \
            libproj-dev \
            libgeos-dev \
            libpq-dev \
            unixodbc-dev \
            libabsl-dev \
            cmake \
            pandoc \
            qpdf \
            lsb-release

      - name: Fix PROJ library symlink
        run: |
          # Ensure libproj.so symlink exists (needed for R packages to link)
          # Some GDAL images only have libproj.so.25
          if [ ! -e "/lib/x86_64-linux-gnu/libproj.so" ]; then
            ln -sf /lib/x86_64-linux-gnu/libproj.so.25 /lib/x86_64-linux-gnu/libproj.so
            ldconfig
          fi

      - name: Install R from CRAN
        run: |
          wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc \
            | tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
          add-apt-repository -y "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
          apt-get update -qq
          apt-get install -y --no-install-recommends r-base r-base-dev

      - name: Print version info
        run: |
          echo "=== Testing: ${{ matrix.package }} on GDAL ${{ matrix.gdal-version }} ==="
          echo ""
          echo "=== GDAL Version ==="
          gdalinfo --version
          echo ""
          echo "=== System PROJ Version (used by R packages) ==="
          pkg-config --modversion proj || true
          echo ""
          echo "=== Internal PROJ Version (used by GDAL, if present) ==="
          proj 2>&1 | head -1 || true
          echo ""
          echo "=== R Version ==="
          R --version | head -3

      - name: Clone package repository
        run: |
          case "${{ matrix.package }}" in
            gdalraster)
              git clone --depth 1 https://github.com/firelab/gdalraster.git pkg
              ;;
            sf)
              git clone --depth 1 https://github.com/r-spatial/sf.git pkg
              ;;
            terra)
              git clone --depth 1 https://github.com/rspatial/terra.git pkg
              ;;
            vapour)
              git clone --depth 1 https://github.com/hypertidy/vapour.git pkg
              ;;
            gdalcubes)
              git clone --depth 1 https://github.com/appelmar/gdalcubes.git pkg
              # gdalcubes R package is in a subdirectory
              if [ -d "pkg/R-package" ]; then
                mv pkg/R-package pkg-r
                rm -rf pkg
                mv pkg-r pkg
              fi
              ;;
            *)
              echo "Unknown package: ${{ matrix.package }}"
              exit 1
              ;;
          esac

      - name: Install R dependencies
        working-directory: pkg
        run: |
          Rscript -e "
            options(repos = c(CRAN = 'https://cloud.r-project.org'))
            options(Ncpus = 2L)
            install.packages(c('remotes', 'knitr', 'rmarkdown', 'testthat'))
            # Install paper-over dependencies e.g. gdalraster: #886
            install.packages(c('vctrs', 'gt')) ## remove me
            # Only install hard dependencies, skip Suggests to avoid circular deps
            remotes::install_deps(dependencies = c('Depends', 'Imports', 'LinkingTo'), upgrade = 'never')
          "

      - name: Build package
        working-directory: pkg
        run: R CMD build --no-build-vignettes .

      - name: Install package
        working-directory: pkg
        run: |
          pkg=$(ls -1 *.tar.gz | head -1)
          # sf and terra: use --no-test-load due to dual-PROJ crash in GDAL images
          # See: https://github.com/OSGeo/gdal/issues/13777
          # See: https://github.com/r-spatial/sf/issues/2570
          case "${{ matrix.package }}" in
            sf|terra)
              echo "Installing with --no-test-load (dual-PROJ issue)"
              R CMD INSTALL --no-test-load "${pkg}"
              ;;
            *)
              R CMD INSTALL "${pkg}"
              ;;
          esac

      - name: Check package
        working-directory: pkg
        env:
          _R_CHECK_FORCE_SUGGESTS_: false
        run: |
          pkg=$(ls -1 *.tar.gz | head -1)
          # sf and terra: skip R CMD check entirely due to dual-PROJ crash on load
          # See: https://github.com/OSGeo/gdal/issues/13777
          # The install step (with --no-test-load) already verified compilation works
          case "${{ matrix.package }}" in
            sf|terra)
              echo "Skipping R CMD check for ${{ matrix.package }} (dual-PROJ crash issue)"
              echo "Compilation succeeded - that's what we're testing for API changes"
              ;;
            *)
              R CMD check --no-manual --ignore-vignettes "${pkg}"
              ;;
          esac

      - name: Show check log on failure
        if: failure()
        working-directory: pkg
        run: |
          for f in *.Rcheck/00check.log *.Rcheck/00install.out; do
            if [ -f "$f" ]; then
              echo "=== $f ==="
              cat "$f"
              echo ""
            fi
          done

      - name: Upload check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: check-results-${{ matrix.package }}-gdal-${{ matrix.gdal-version }}
          path: pkg/*.Rcheck
          retention-days: 30

  summary:
    name: Summary
    needs: check
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## GDAL Compatibility Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested GDAL versions: 3.9, 3.12 (stable), latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** sf and terra run compile-only checks due to dual-PROJ crash in GDAL Docker images." >> $GITHUB_STEP_SUMMARY
          echo "See: https://github.com/OSGeo/gdal/issues/13777" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check.result }}" == "success" ]; then
            echo "All packages passed! âœ…" >> $GITHUB_STEP_SUMMARY
          else
            echo "Some packages failed - check individual job logs" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: needs.check.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `GDAL compatibility check failed - ${date}`;
            const body = `The scheduled GDAL compatibility check has detected failures.

            Please check the [workflow run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}) for details.

            This may indicate API changes in the latest GDAL that affect R packages.

            **Note:** sf and terra run compile-only checks due to dual-PROJ crash in GDAL Docker images.
            See: https://github.com/OSGeo/gdal/issues/13777`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['gdal-compatibility', 'automated']
            });
